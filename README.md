# Face Detection and Cropping Node for ComfyUI

## 功能介绍

这是一个专为ComfyUI设计的面部检测和裁剪节点，可以从输入图片中检测面部并按照指定参数进行裁剪。

## 主要功能

1. **面部检测**: 使用MediaPipe检测图片中的所有面部
2. **智能排序**: 按距离图片中心点的距离排序，然后按从左到右的顺序输出
3. **灵活裁剪**: 支持缩放因子和偏移因子调整裁剪区域
4. **多种纵横比**: 支持常见的图片比例（1:1, 4:3, 16:9等）
5. **批量处理**: 可以一次处理多个面部并输出为batch

## 参数说明

### 输入参数

- **image**: 输入图片
- **number_of_faces**: 需要识别的面部数量（1-50，默认1）
- **scale_factor**: 裁剪区域缩放因子（0.5-3.0，默认1.5）
- **shift_factor**: 裁剪区域偏移因子（-1.0到1.0，默认0.0）
- **start_index**: 从第几个面部开始获取（0-49，默认0）
- **max_faces_per_image**: 每张图片最多检测的面部数量（0-50，默认50）
- **aspect_ratio**: 输出图片的纵横比例（1:1, 4:3, 3:4, 16:9, 9:16, 3:2, 2:3）

### 输出

- **cropped_faces**: 裁剪后的面部图片batch

## 安装方法

1. 将此文件夹复制到ComfyUI的`custom_nodes`目录下
2. 安装依赖包：
   ```bash
   pip install -r requirements.txt
   ```
3. 重启ComfyUI

## 依赖包

- opencv-python>=4.8.0
- mediapipe>=0.10.0
- numpy>=1.24.0
- torch
- torchvision
- Pillow>=9.0.0

## 使用示例

1. 在ComfyUI工作流中添加"面部检测裁剪"节点
2. 连接图片输入
3. 调整参数：
   - `number_of_faces`: 设置要提取的面部数量
   - `scale_factor`: 调整裁剪区域大小（>1.0放大，<1.0缩小）
   - `shift_factor`: 调整裁剪位置（正值向右下偏移，负值向左上偏移）
   - `aspect_ratio`: 选择输出图片比例
4. 连接输出到后续节点

## 工作原理

1. **面部检测**: 使用MediaPipe的人脸检测模型识别图片中的所有面部
2. **距离排序**: 计算每个面部中心点到图片中心点的距离，按距离从近到远排序
3. **位置排序**: 从距离最近的面部中选择指定数量，然后按从左到右的X坐标排序
4. **区域裁剪**: 根据scale_factor和shift_factor计算裁剪区域
5. **比例调整**: 根据指定的aspect_ratio调整输出图片尺寸
6. **批量输出**: 将所有裁剪后的面部图片组合成一个batch返回

## 注意事项

- 确保输入图片包含清晰可见的人脸
- scale_factor建议设置在1.2-2.0之间以获得最佳效果
- 如果检测不到面部，节点会返回空的tensor
- 输出的图片会自动转换为RGB格式并归一化到[0,1]范围

## 版本信息

- 版本: 1.0.0
- 兼容ComfyUI版本: 最新版本
- 作者: AI Assistant
